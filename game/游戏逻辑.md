

#第二部分 游戏逻辑


##战斗计算【最重要】
为了方便数值策划调试数值，【必须】单独书写一个调试接口，供数值模拟演算战斗情况。


##场景同步【最吃资源】

战斗，移动同步
场景网格划分。（在场景元素管理中，用四叉树取代现在的链表结构，场景网格结构，早就过时了，现在2d普遍用四叉树，3d用八叉树）




##怪物AI【耗资源】
怪物的AI是靠定时器即使刷新的，以便根据自身的情况即使改变自己的状态，比如是巡逻、攻击、追击、返回等，几乎一款游戏有很多的怪物，怪物的行为不一值，所以需要添加的定时器也很多；我们优化的方向是当怪物巡逻时，我们将定时器的间隔设置的长一些，当怪物收到攻击之后，我们将怪物AI的定时器设置的短些。

一个怪物如果不在任何一个玩家的视野内，其应该是不占用任何AI资源的。也就是AI由它第一次进入玩家视野的时候触发,如果它离开了所有玩家的视野，AI应该被终止，这样可以节省很多无谓的AI资源消耗。

把AI独立服务器的处理方法大致上如下
当需要AOI广播的时候，把Monster也作为对象记录下来，并当成普通User来处理。发送的时候，所有发往同一AI服务器的消息只发送1次，这样AI服务器就会获得各种移动攻击等消息的同步，接下来，你在AI服务器上做逻辑判断后，将攻击/移动等操作通过消息发往游戏服务器/场景服务器处理即可。但需要做逻辑合并处理。


##A*寻路

必须得寻路，先用dda直线算法，直线寻路又叫视线寻路，如果中间有障碍再用a*

##任务调度


##全服组队，全服交易

需要单独进程或线程处理，由RPC来配合通信


##聊天，通知系统，跨服邮件
可以考虑消息中心：发布者-订阅者（Publisher-Subscriber）的设计思路。
组队聊天，公会聊天，世界聊天，全服大喇叭

需要单独进程或线程处理，由RPC来配合通信


##新手村拥堵
新手村问题：《天龙八部》提出了较好的解决方案，建立多个平行的新手村地图，一主多副，开服时尽可能多的同时容纳新用户的涌入，高等级玩家从其它地图回新手村只能到达主新手村。
类似于场景的分线处理。



##服务器状态：
0：未开启 【前端不能进入】
1：繁忙
2：良好
3：空闲
4：维护中 【前端不能进入】
5：提前录入，前端不能显示出来


##背包：

我们希望可以追踪每件可能被交易的物品，每件物品都有 64bit 的唯一 id 。在背包格里可以叠加若干件相同物品，但是每件物品都有单独 id 。这个 id 是用于最终和拥有者校验用的，不必传输给客户端，在交易系统外也不需要被读取。

物品是以 lua 对象的形式保存在内存中的，不同类别的物品有不同的方法可以获得物品的不同属性。

玩家制造的装备，需要记录下装备制造者的名字。或是有用宝石强化过的装备，需要记录强化信息。


背包有几个基本操作：
```
QUERY：查询一个物品格里的物品对象和数量。
TRADEOUT ：把一个物品格里的所有物品都拿出来。生成一个交易单。这个 API 主要是把物品从背包里抹掉，如果物品格对仓库有引用，也同时抹掉。返回的交易单是一组纯数据，里面有物品的序列化信息，以及所有的物品唯一 id 。
TRADEIN ：把一个交易单里提到的所有物品，合并到一个物品格里。这个是 TRADEOUT 的逆操作。
EXCHANGE ：交换两个物品格。
SPLIT ：把一个物品格内的多件物品分割成两份，放在新的格子中。
CONSUME ：消耗掉一个物品格中的若干件物品。
```
