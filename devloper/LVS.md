##VS/NAT：
NAT的工作原理是报文头（目标地址、源地址和端口等）被正确改写后，客户相信它们连接一个IP地址，而不同IP地址的服务器组也认为它们是与客户直接相连的。由此，可以用NAT方法将不同IP地址的并行网络服务变成在一个IP地址上的一个虚拟服务。

访问Web服务的报文可能有以下的源地址和目标地址：
SOURCE   202.100.1.2:3456    DEST    202.103.106.5:80
调度器从调度列表中选出一台服务器，例如是172.16.0.3:8000。该报文会被改写为如下地址，并将它发送给选出的服务器。
SOURCE   202.100.1.2:3456    DEST    172.16.0.3:8000
从服务器返回到调度器的响应报文如下：
SOURCE   172.16.0.3:8000     DEST    202.100.1.2:3456
响应报文的源地址会被改写为虚拟服务的地址，再将报文发送给客户：
SOURCE   202.103.106.5:80    DEST    202.100.1.2:3456
这样，客户认为是从202.103.106.5:80服务得到正确的响应，而不会知道该请求是服务器172.16.0.2还是服务器172.16.0.3处理的。

##VS/TUN
在VS/NAT的集群系统中，请求和响应的数据报文都需要通过负载调度器，当真实服务器的数目在10台和20台之间时，负载调度器将成为整个集群系统的新瓶颈。大多数Internet服务都有这样的特点：请求报文较短而响应报文往往包含大量的数据。如果能将请求和响应分开处理，即在负载调度器中只负责调度请求而响应直接返回给客户，将极大地提高整个集群系统的吞吐量。

VS/TUN的工作流程：它的连接调度和管理与VS/NAT中的一样，只是它的报文转发方法不同。调度器根据各个服务器的负载情况，动态地选择一台服务器，[将请求报文封装在另一个IP报文中]，再将封装后的IP报文转发给选出的服务器；服务器收到报文后，先将报文解封获得原来目标地址为VIP的报文，服务器发现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。

流程：
[VIP--packet] ---> [svrIP[VIP--packet]] ====(internet)====> [svrIP[VIP--packet]] -->[VIP--packet]

在VS/TUN中，响应报文根据服务器的路由表直接返回给客户，而不经过负载调度器，所以负载调度器只处于从客户到服务器的半连接中,VS/TUN的TCP状态迁移是按照半连接的TCP有限状态机进行的.

##VS/DR
性能最佳！负载调度器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高整个集群系统的吞吐量。该方法与IBM的NetDispatcher产品中使用的方法类似，但IBM的NetDispatcher是非常昂贵的商品化产品。

通过直接路由实现虚拟服务器（VS/DR）:
VS/DR的体系结构：调度器和服务器组都必须在物理上有一个网卡通过不分段的局域网相连，即通过交换机或者高速的HUB相连，中间没有隔有路由器。

VS/DR的工作流程：它的连接调度和管理与VS/NAT和VS/TUN中的一样，它的报文转发方法又有不同，将报文直接路由给目标服务器。在VS/DR中，调度器根据各个服务器的负载情况，动态地选择一台服务器，不修改也不封装IP报文，而是将数据帧的MAC地址改为选出服务器的MAC地址，再将修改后的数据帧在与服务器组的局域网上发送。因为数据帧的MAC地址是选出的服务器，所以服务器肯定可以收到这个数据帧，从中可以获得该IP报文。当服务器发现报文的目标地址VIP是在本地的网络设备上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。

[VIP--packet] ---> [svr MAC ..[VIP--packet]] ====(internet)====> [svr MAC...[VIP--packet]] -->[VIP--packet]

VS/DR负载调度器也只处于从客户到服务器的半连接中，按照半连接的TCP有限状态机进行状态迁移。


##Keepalived原理
Layer3,4&7工作在IP/TCP协议栈的IP层，TCP层，及应用层,原理分别如下：
Layer3：Keepalived使用Layer3的方式工作式时，Keepalived会定期向服务器群中的服务器发送一个ICMP的数据包（既我们平时用的Ping程序）,如果发现某台服务的IP地址没有激活，Keepalived便报告这台服务器失效，并将它从服务器群中剔除，这种情况的典型例子是某台服务器被非法关机。Layer3的方式是以服务器的IP地址是否有效作为服务器工作正常与否的标准。
Layer4:如果您理解了Layer3的方式，Layer4就容易了。Layer4主要以TCP端口的状态来决定服务器工作正常与否。如web server的服务端口一般是80，如果Keepalived检测到80端口没有启动，则Keepalived将把这台服务器从服务器群中剔除。
Layer7：Layer7就是工作在具体的应用层了，比Layer3,Layer4要复杂一点，在网络上占用的带宽也要大一些。Keepalived将根据用户的设定检查服务器程序的运行是否正常，如果与用户的设定不相符，则Keepalived将把服务器从服务器群中剔除。

keepalived配置：
1.全局配置, 
2.vrrpd配置，核心 
3.LVS配置,通过keepalived来配置管理LVS需要配置。

##LVS部署
IP负载均衡技术
http://zh.linuxvirtualserver.org/node/25

LVS + Keepalived之tun模式
http://www.gaizaoren.org/archives/1002
http://blog.0550go.com/lvs-3/

如果要使用华为云服务器的防火墙，需要部署VS/TUN + keepalived环境。
如此华为云的流量为：in：request流量， out：request流量+1%
那么睿江老机房的流量不变。但有效的把真实IP隐藏起来了，keepalived也承载了服务器的硬件的冗余。

另外需要还需要部署DNS的冗余切换，防止华为云的网络故障。

高可用web架构: LVS+keepalived+nginx+apache+php+eaccelerator（+nfs可选 可不选）


##other 
varnish-cache.org 

